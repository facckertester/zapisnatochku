<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ì—Ä–∞—Ñ–∏–∫ —Ç–æ—á–µ–∫</title>
  <style>
    :root {
      --bg: #f0f4f8;
      --fg: #333;
      --container-bg: #fff;
      --input-bg: #fff;
      --input-border: #ccc;
      --button-bg: #007bff;
      --button-fg: white;
    }
    body.dark {
      --bg: #1e1e1e;
      --fg: #f0f0f0;
      --container-bg: #2a2a2a;
      --input-bg: #333;
      --input-border: #666;
      --button-bg: #444;
      --button-fg: #f0f0f0;
    }
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 1rem;
      background: var(--bg);
      color: var(--fg);
      transition: all 0.3s ease;
    }
    .container {
      max-width: 500px;
      margin: auto;
      background: var(--container-bg);
      padding: 1rem;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      transition: background 0.3s ease;
    }
    h2, h3 {
      text-align: center;
    }
    label {
      display: block;
      margin-top: 1rem;
    }
    input, select, button {
      width: 100%;
      box-sizing: border-box;
      padding: 10px;
      font-size: 1rem;
      border-radius: 5px;
      border: 1px solid var(--input-border);
      background: var(--input-bg);
      color: var(--fg);
    }
    button {
      background: var(--button-bg);
      color: var(--button-fg);
      border: none;
      margin-top: 1rem;
      cursor: pointer;
    }
    #assignments > div {
      margin-bottom: 1.5em;
    }
    button:disabled {
      background: #aaa;
      cursor: not-allowed;
    }
    .entry {
      background: #f9f9f9;
      padding: 5px 10px;
      border-radius: 5px;
      margin-top: 5px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: #000;
    }
    .entry span {
      flex: 1;
    }
    .admin-section {
      margin-top: 2rem;
      border-top: 1px solid #ccc;
      padding-top: 1rem;
    }
    .week-selector {
      display: flex;
      align-items: center;
      gap: 5px;
      margin-bottom: 1rem;
    }
    .week-selector button {
      flex: 1;
      height: 44px;
      padding: 0;
      font-size: 0.9rem;
      max-width: 80px;
    }
    .week-selector input {
      height: 44px;
      text-align: center;
      font-weight: bold;
      flex: 2;
      border-radius: 5px;
    }
    .edit-btn {
      margin-left: 10px;
      font-size: 1.1rem;
      background: none;
      border: none;
      color: #007bff;
      cursor: pointer;
    }
    .edit-btn:hover {
      color: #0056b3;
    }
    .danger {
      color: #dc3545;
    }
    .theme-toggle {
      text-align: center;
      margin-bottom: 1rem;
    }
    .theme-toggle button {
      width: auto;
      padding: 8px 16px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="theme-toggle">
      <button onclick="toggleTheme()" id="themeBtn">–¢—ë–º–Ω–∞—è —Ç–µ–º–∞</button>
    </div>

    <h2>–ì—Ä–∞—Ñ–∏–∫ –ø–æ –Ω–µ–¥–µ–ª—è–º</h2>

    <div class="week-selector">
      <button onclick="changeWeek(-1)">‚Üê –ø—Ä–µ–¥. –Ω–µ–¥–µ–ª—è</button>
      <input type="text" id="week" readonly>
      <button onclick="changeWeek(1)">—Å–ª–µ–¥. –Ω–µ–¥–µ–ª—è ‚Üí</button>
    </div>

    <label for="name">–ò–º—è:</label>
    <input type="text" id="name" autocomplete="off" />

    <label for="day">–î–µ–Ω—å –Ω–µ–¥–µ–ª–∏:</label>
    <select id="day">
      <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–Ω—å</option>
      <option>–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫</option>
      <option>–í—Ç–æ—Ä–Ω–∏–∫</option>
      <option>–°—Ä–µ–¥–∞</option>
      <option>–ß–µ—Ç–≤–µ—Ä–≥</option>
      <option>–ü—è—Ç–Ω–∏—Ü–∞</option>
      <option>–°—É–±–±–æ—Ç–∞</option>
      <option>–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ</option>
    </select>

    <label for="point">–¢–æ—á–∫–∞:</label>
    <select id="point">
      <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ—á–∫—É</option>
      <option>–í–∞—Ç–∞ - –ú–æ—Ä–æ–∂–µ–Ω–æ–µ</option>
      <option>–ë–∞—Ç—É—Ç</option>
      <option>–ú–∞—à–∏–Ω–∫–∏ - –õ–∞–±–∏—Ä–∏–Ω—Ç</option>
      <option>–ê—Ä–∫–∞–¥–∞ - –¢–∏—Ä</option>
    </select>

    <button onclick="assignPoint()">–ó–∞–ø–∏—Å–∞—Ç—å—Å—è</button>

    <h3>–ù–∞–∑–Ω–∞—á–µ–Ω–∏—è</h3>
    <div id="assignments"></div>

    <div class="admin-section">
      <label for="adminPass">–ü–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞:</label>
      <input type="password" id="adminPass" autocomplete="off" />
      <button onclick="checkAdmin()">–í–æ–π—Ç–∏ –∫–∞–∫ –∞–¥–º–∏–Ω</button>

      <div id="adminControls" style="display:none;">
        <button onclick="resetWeek()" style="background:#dc3545;">–°–±—Ä–æ—Å–∏—Ç—å –Ω–µ–¥–µ–ª—é</button>
      </div>
    </div>
  </div>

  <script>
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbybL2_H3XqseobbTI2BReWuc0azQoaNrAgz8GgWG6WpRl8hxTJizSXzaYeqBoOar3L9XQ/exec';
    const password = "2808";
    let isAdmin = false;
    let weekOffset = 0;
    let Schedule = {};
    let currentWeekKey = "";

    const daysOrder = ["–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫", "–í—Ç–æ—Ä–Ω–∏–∫", "–°—Ä–µ–¥–∞", "–ß–µ—Ç–≤–µ—Ä–≥", "–ü—è—Ç–Ω–∏—Ü–∞", "–°—É–±–±–æ—Ç–∞", "–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ"];

    function getMonday(d, offset = 0) {
      const date = new Date(d);
      const day = date.getDay();
      const diff = date.getDate() - (day === 0 ? 6 : day - 1) + offset * 7;
      return new Date(date.setDate(diff));
    }

    function getWeekKey(mondayDate) {
      return mondayDate.toISOString().split("T")[0];
    }

    function getMonthName(date) {
      return date.toLocaleString("ru-RU", { month: "long" });
    }

    function formatWeek(mondayDate) {
      const sunday = new Date(mondayDate);
      sunday.setDate(mondayDate.getDate() + 6);
      return `${mondayDate.getDate()} ${getMonthName(mondayDate)} ‚Äî ${sunday.getDate()} ${getMonthName(sunday)}`;
    }

    async function loadSchedule() {
      const monday = getMonday(new Date(), weekOffset);
      currentWeekKey = getWeekKey(monday);
      document.getElementById("week").value = formatWeek(monday);

      try {
        const response = await fetch(GAS_URL + `?action=get&week=${currentWeekKey}`);
        const data = await response.json();
        Schedule = data.Schedule || {};
        updateDisplay();
      } catch (e) {
        alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è: " + e.message);
        Schedule = {};
        updateDisplay();
      }
    }

    async function saveSchedule() {
      try {
        const response = await fetch(GAS_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'save', week: currentWeekKey, Schedule })
        });
        const data = await response.json();
        if (!data.success) alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: " + (data.message || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"));
      } catch (e) {
        alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: " + e.message);
      }
    }

    function updateDisplay() {
      const output = document.getElementById("assignments");
      output.innerHTML = "";

      daysOrder.forEach(day => {
        if (!e[day]) return;

        const points = e[day];
        const dayBlock = document.createElement("div");
        dayBlock.innerHTML = `<strong>${day}:</strong>`;

        Object.keys(points).forEach(pt => {
          const entry = document.createElement("div");
          entry.className = "entry";

          const span = document.createElement("span");
          span.textContent = `${pt} ‚Äî ${points[pt]}`;
          entry.appendChild(span);

          if (isAdmin) {
            const editBtn = document.createElement("button");
            editBtn.innerHTML = "‚úèÔ∏è";
            editBtn.className = "edit-btn";
            editBtn.title = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å";
            editBtn.onclick = () => editEntry(day, pt);
            entry.appendChild(editBtn);

            const delBtn = document.createElement("button");
            delBtn.innerHTML = "üóëÔ∏è";
            delBtn.className = "edit-btn danger";
            delBtn.title = "–£–¥–∞–ª–∏—Ç—å";
            delBtn.onclick = () => deleteEntry(day, pt);
            entry.appendChild(delBtn);
          }

          dayBlock.appendChild(entry);
        });

        output.appendChild(dayBlock);
      });

      updatePointOptions();
    }

    function updatePointOptions() {
      const daySelect = document.getElementById("day");
      const pointSelect = document.getElementById("point");

      const selectedDay = daySelect.value;
      if (!selectedDay) {
        enableAllPoints();
        return;
      }

      const takenPoints = e[selectedDay] ? Object.keys(e[selectedDay]) : [];

      for (let i = 0; i < pointSelect.options.length; i++) {
        const option = pointSelect.options[i];
        if (option.value === "") continue;
        option.disabled = takenPoints.includes(option.value);
      }
    }

    function enableAllPoints() {
      const pointSelect = document.getElementById("point");
      for (let i = 0; i < pointSelect.options.length; i++) {
        pointSelect.options[i].disabled = false;
      }
    }

    async function assignPoint() {
      const name = document.getElementById("name").value.trim();
      const day = document.getElementById("day").value;
      const point = document.getElementById("point").value;

      if (!name) {
        alert("–í–≤–µ–¥–∏—Ç–µ –∏–º—è");
        return;
      }
      if (!day) {
        alert("–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏");
        return;
      }
      if (!point) {
        alert("–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ—á–∫—É");
        return;
      }

      if (!Schedule[day]) Schedule[day] = {};
      if (Schedule[day][point]) {
        alert("–≠—Ç–∞ —Ç–æ—á–∫–∞ —É–∂–µ –∑–∞–Ω—è—Ç–∞ –≤ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –¥–µ–Ω—å");
        return;
      }

      Schedule[day][point] = name;
      await saveSchedule();
      updateDisplay();

      document.getElementById("name").value = "";
      document.getElementById("day").value = "";
      document.getElementById("point").value = "";
      enableAllPoints();
    }

    async function editEntry(day, point) {
      const currentName = Schedule[day][point];
      const newName = prompt(`–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–º—è –¥–ª—è —Ç–æ—á–∫–∏ "${point}" –≤ ${day}:`, currentName);
      if (newName === null) return;
      const trimmed = newName.trim();
      if (!trimmed) {
        alert("–ò–º—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º");
        return;
      }
      Schedule[day][point] = trimmed;
      await saveSchedule();
      updateDisplay();
    }

    async function deleteEntry(day, point) {
      if (!confirm(`–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å —Å —Ç–æ—á–∫–∏ "${point}" –≤ ${day}?`)) return;
      delete Schedule[day][point];
      if (Object.keys(Schedule[day]).length === 0) {
        delete Schedule[day];
      }
      await saveSchedule();
      updateDisplay();
    }

    function checkAdmin() {
      const entered = document.getElementById("adminPass").value;
      if (entered === password) {
        isAdmin = true;
        alert("–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ");
        document.getElementById("adminControls").style.display = "block";
        document.getElementById("adminPass").value = "";
        updateDisplay();
      } else {
        alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å");
      }
    }

    async function resetWeek() {
      if (!isAdmin) return;
      if (!confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –∑–∞–ø–∏—Å–∏ —ç—Ç–æ–π –Ω–µ–¥–µ–ª–∏?")) return;

      try {
        const response = await fetch(GAS_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'reset', week: currentWeekKey })
        });
        const data = await response.json();
        if (data.success) {
          Schedule = {};
          updateDisplay();
          alert("–ù–µ–¥–µ–ª—è —Å–±—Ä–æ—à–µ–Ω–∞");
        } else {
          alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ: " + (data.message || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"));
        }
      } catch (e) {
        alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ: " + e.message);
      }
    }

    async function changeWeek(delta) {
      weekOffset += delta;
      await loadSchedule();
    }

    function toggleTheme() {
      document.body.classList.toggle("dark");
      const btn = document.getElementById("themeBtn");
      if (document.body.classList.contains("dark")) {
        btn.textContent = "–°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞";
      } else {
        btn.textContent = "–¢—ë–º–Ω–∞—è —Ç–µ–º–∞";
      }
    }

    document.getElementById("day").addEventListener("change", updatePointOptions);

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    loadSchedule();
  </script>
</body>
</html>
